<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ” æç®€åŠ å¯† Â· ç‚¹å¯¹ç‚¹èŠå¤©</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }
        body {
            background: #0a0f1a;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px;
        }
        .app {
            max-width: 1000px;
            width: 100%;
            height: 90vh;
            background: #151f2b;
            border-radius: 32px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.6);
            border: 1px solid #2d4055;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .header {
            padding: 16px 20px;
            background: #1e2c3c;
            border-bottom: 1px solid #354b66;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .header h2 {
            color: #ffd966;
            font-size: 1.4rem;
        }
        .key-badge {
            background: #2a3f5a;
            padding: 6px 14px;
            border-radius: 40px;
            font-family: monospace;
            font-size: 0.8rem;
            color: #aac8ff;
            border: 1px solid #5a7bb5;
        }
        .connect-bar {
            padding: 12px 20px;
            background: #172635;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            border-bottom: 1px solid #2e4565;
        }
        .peer-id {
            background: #1e314a;
            border: 1px solid #4a70b0;
            border-radius: 40px;
            padding: 8px 16px;
            font-family: monospace;
            font-size: 0.8rem;
            flex: 1;
            min-width: 160px;
            color: #bbd9ff;
        }
        button {
            background: #2d5090;
            border: none;
            color: white;
            padding: 8px 18px;
            border-radius: 40px;
            font-weight: 500;
            cursor: pointer;
            border: 1px solid #5f8ae0;
            transition: 0.15s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        button:hover {
            background: #3e67b5;
            transform: scale(1.02);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .remote-input {
            background: #1e314a;
            border: 1px solid #4a70b0;
            border-radius: 40px;
            padding: 8px 16px;
            color: white;
            outline: none;
            flex: 1;
            min-width: 140px;
        }
        .toolbar {
            padding: 10px 20px;
            background: #172938;
            display: flex;
            gap: 10px;
            border-bottom: 1px solid #2f4a70;
        }
        .emoji-panel {
            display: flex;
            gap: 8px;
            background: #253c60;
            padding: 5px 15px;
            border-radius: 40px;
        }
        .emoji {
            font-size: 1.5rem;
            cursor: pointer;
        }
        .emoji:hover {
            transform: scale(1.2);
        }
        .attach-btn {
            background: #253c60;
            border-radius: 40px;
            padding: 5px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        #fileInput {
            display: none;
        }
        .messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: #0f1a28;
        }
        .message {
            display: flex;
            flex-direction: column;
            max-width: 80%;
        }
        .message.self {
            align-self: flex-end;
        }
        .message.other {
            align-self: flex-start;
        }
        .bubble {
            padding: 10px 16px;
            border-radius: 24px;
            background: #1e345a;
            border: 1px solid #3b66b0;
            word-break: break-word;
        }
        .self .bubble {
            background: #2b4d8a;
            border-bottom-right-radius: 6px;
        }
        .other .bubble {
            border-bottom-left-radius: 6px;
        }
        .media-content {
            max-width: 100%;
            border-radius: 12px;
            max-height: 200px;
        }
        .signature {
            font-size: 0.7rem;
            margin-top: 4px;
            padding: 0 10px;
            display: flex;
            gap: 16px;
            color: #9bb3e0;
        }
        .self .signature {
            justify-content: flex-end;
        }
        .input-area {
            display: flex;
            padding: 16px 20px 20px;
            background: #151f2b;
            gap: 10px;
            border-top: 1px solid #2b4370;
        }
        .text-field {
            flex: 1;
            background: #1f3660;
            border-radius: 30px;
            padding: 8px 18px;
            border: 1px solid #4570c0;
        }
        #textInput {
            width: 100%;
            background: transparent;
            border: none;
            color: white;
            resize: none;
            outline: none;
            font-size: 1rem;
            max-height: 100px;
        }
        .send-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #3a6cd0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            border: 1px solid #7fa3ff;
        }
        .status-bar {
            padding: 8px 20px;
            background: #0e1a2a;
            color: #90b0f0;
            font-size: 0.8rem;
            display: flex;
            justify-content: space-between;
            border-top: 1px solid #2f4a7a;
        }
    </style>
</head>
<body>
<div class="app">
    <div class="header">
        <h2><i class="fas fa-lock" style="color: #ffd966;"></i> æç®€åŠ å¯† Â· ç›´è¿</h2>
        <div class="key-badge" id="keyDisplay">å¯†é’¥: 50ä½å›ºå®šå¯†ç </div>
    </div>

    <div class="connect-bar">
        <div class="peer-id" id="peerIdDisplay">åˆå§‹åŒ–ä¸­...</div>
        <button id="copyIdBtn"><i class="far fa-copy"></i> å¤åˆ¶ID</button>
        <input type="text" class="remote-input" id="remoteIdInput" placeholder="ç²˜è´´å¯¹æ–¹ID">
        <button id="connectBtn"><i class="fas fa-link"></i> è¿æ¥</button>
        <button id="disconnectBtn" style="background:#6b4f8f;"><i class="fas fa-times"></i> æ–­å¼€</button>
    </div>

    <div class="toolbar">
        <div class="emoji-panel">
            <span class="emoji" data-emoji="ğŸ˜€">ğŸ˜€</span>
            <span class="emoji" data-emoji="ğŸ˜‚">ğŸ˜‚</span>
            <span class="emoji" data-emoji="ğŸ˜">ğŸ˜</span>
            <span class="emoji" data-emoji="ğŸ‘">ğŸ‘</span>
            <span class="emoji" data-emoji="ğŸ‰">ğŸ‰</span>
            <span class="emoji" data-emoji="ğŸ”¥">ğŸ”¥</span>
        </div>
        <div class="attach-btn" id="attachBtn">
            <i class="fas fa-paperclip"></i> å›¾ç‰‡/è§†é¢‘
        </div>
        <input type="file" id="fileInput" accept="image/*,video/*">
    </div>

    <div class="messages" id="messageArea"></div>

    <div class="input-area">
        <div class="text-field">
            <textarea id="textInput" placeholder="è¾“å…¥æ¶ˆæ¯..." rows="1"></textarea>
        </div>
        <button class="send-btn" id="sendBtn"><i class="fas fa-paper-plane"></i></button>
    </div>

    <div class="status-bar">
        <span id="connectionStatus"><i class="fas fa-wifi"></i> æœªè¿æ¥</span>
        <span id="clearHistory" style="cursor:pointer;"><i class="far fa-trash-alt"></i> æ¸…ç©º</span>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script>
(function() {
    // ---------- 50ä½å›ºå®šå¯†ç ï¼ˆç›´æ¥ç”¨ä½œåŠ è§£å¯†å¯†é’¥ï¼‰----------
    const SECRET_KEY = "X8k9#mP2$rT5vLq7@wN4jY6zU3cF1hA8eB9dC4fG6hJ2kL5nM7pQ9rS2tU5vW8x";
    document.getElementById('keyDisplay').innerText = 'å¯†é’¥: 50ä½å›ºå®šå¯†ç ';

    // çŠ¶æ€å˜é‡
    let myName = "æˆ‘";
    let myPeerId = null;
    let connections = []; // å­˜å‚¨æ‰€æœ‰è¿æ¥
    let peer = null;

    // DOM å…ƒç´ 
    const peerIdDisplay = document.getElementById('peerIdDisplay');
    const copyIdBtn = document.getElementById('copyIdBtn');
    const remoteIdInput = document.getElementById('remoteIdInput');
    const connectBtn = document.getElementById('connectBtn');
    const disconnectBtn = document.getElementById('disconnectBtn');
    const sendBtn = document.getElementById('sendBtn');
    const textInput = document.getElementById('textInput');
    const messageArea = document.getElementById('messageArea');
    const connectionStatus = document.getElementById('connectionStatus');
    const clearHistoryBtn = document.getElementById('clearHistory');
    const fileInput = document.getElementById('fileInput');
    const attachBtn = document.getElementById('attachBtn');

    // ---------- åŠ å¯†è§£å¯† (ç›´æ¥ä½¿ç”¨50ä½å¯†ç ) ----------
    function encrypt(plain) {
        if (!plain) return plain;
        try {
            const textBytes = new TextEncoder().encode(plain);
            const keyBytes = new TextEncoder().encode(SECRET_KEY);
            const cipher = new Uint8Array(textBytes.length);
            for (let i = 0; i < textBytes.length; i++) {
                cipher[i] = textBytes[i] ^ keyBytes[i % keyBytes.length];
            }
            return 'ğŸ”' + btoa(String.fromCharCode(...cipher));
        } catch (e) {
            console.error('åŠ å¯†å¤±è´¥:', e);
            return plain;
        }
    }

    function decrypt(encoded) {
        if (!encoded || !encoded.startsWith('ğŸ”')) return encoded;
        try {
            const base64 = encoded.slice(1);
            const binary = atob(base64);
            const cipherBytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) {
                cipherBytes[i] = binary.charCodeAt(i);
            }
            const keyBytes = new TextEncoder().encode(SECRET_KEY);
            const plainBytes = new Uint8Array(cipherBytes.length);
            for (let i = 0; i < cipherBytes.length; i++) {
                plainBytes[i] = cipherBytes[i] ^ keyBytes[i % keyBytes.length];
            }
            return new TextDecoder().decode(plainBytes);
        } catch (e) {
            console.error('è§£å¯†å¤±è´¥:', e);
            return '[è§£å¯†å¤±è´¥]';
        }
    }

    // æ–‡ä»¶è½¬Base64
    function fileToBase64(file, callback) {
        const reader = new FileReader();
        reader.onload = () => callback(reader.result.split(',')[1]);
        reader.readAsDataURL(file);
    }

    // æ·»åŠ æ–‡å­—æ¶ˆæ¯åˆ°ç•Œé¢
    function addMessageToUI(content, senderName) {
        const msgDiv = document.createElement('div');
        msgDiv.classList.add('message', senderName === myName ? 'self' : 'other');
        
        const bubble = document.createElement('div');
        bubble.classList.add('bubble');
        bubble.textContent = content;
        
        const sig = document.createElement('div');
        sig.classList.add('signature');
        const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        sig.innerHTML = `<span>${senderName}</span> <span>${time}</span>`;
        
        msgDiv.appendChild(bubble);
        msgDiv.appendChild(sig);
        messageArea.appendChild(msgDiv);
        messageArea.scrollTop = messageArea.scrollHeight;
    }

    // æ˜¾ç¤ºåª’ä½“æ¶ˆæ¯
    function displayMedia(base64, type, senderName) {
        const msgDiv = document.createElement('div');
        msgDiv.classList.add('message', senderName === myName ? 'self' : 'other');
        
        const bubble = document.createElement('div');
        bubble.classList.add('bubble');
        
        if (type === 'image') {
            const img = document.createElement('img');
            img.classList.add('media-content');
            img.src = 'data:image/png;base64,' + base64;
            bubble.appendChild(img);
        } else {
            const video = document.createElement('video');
            video.classList.add('media-content');
            video.controls = true;
            video.src = 'data:video/mp4;base64,' + base64;
            bubble.appendChild(video);
        }
        
        const sig = document.createElement('div');
        sig.classList.add('signature');
        const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        sig.innerHTML = `<span>${senderName}</span> <span>${time}</span>`;
        
        msgDiv.appendChild(bubble);
        msgDiv.appendChild(sig);
        messageArea.appendChild(msgDiv);
        messageArea.scrollTop = messageArea.scrollHeight;
    }

    // å¹¿æ’­ç»™æ‰€æœ‰è¿æ¥
    function broadcastToAll(encryptedData, excludeConn = null) {
        connections.forEach(c => {
            if (c.conn && c.conn.open && c.conn !== excludeConn) {
                c.conn.send(encryptedData);
            }
        });
    }

    // å¤„ç†æ¥æ”¶åˆ°çš„æ•°æ®
    function handleIncomingData(encryptedData, senderConn) {
        const decrypted = decrypt(encryptedData);
        const senderEntry = connections.find(c => c.conn === senderConn);
        const senderName = senderEntry ? senderEntry.memberName : 'å¯¹æ–¹';

        if (decrypted.startsWith('NICKNAME:')) {
            // æ›´æ–°æ˜µç§°
            if (senderEntry) {
                senderEntry.memberName = decrypted.replace('NICKNAME:', '');
                // æ›´æ–°æˆå‘˜åˆ—è¡¨æ˜¾ç¤º
                updateMembersList();
            }
        } else if (decrypted.startsWith('IMAGE_BASE64:')) {
            displayMedia(decrypted.replace('IMAGE_BASE64:', ''), 'image', senderName);
        } else if (decrypted.startsWith('VIDEO_BASE64:')) {
            displayMedia(decrypted.replace('VIDEO_BASE64:', ''), 'video', senderName);
        } else {
            addMessageToUI(decrypted, senderName);
        }
    }

    // æ›´æ–°æˆå‘˜åˆ—è¡¨æ˜¾ç¤º
    function updateMembersList() {
        // è¿™ä¸ªç‰ˆæœ¬ç®€åŒ–ï¼Œä¸å®ç°å·¦ä¾§æˆå‘˜åˆ—è¡¨ï¼Œåªæ˜¾ç¤ºè¿æ¥æ•°
        connectionStatus.innerHTML = `<i class="fas fa-wifi"></i> åœ¨çº¿: ${connections.length}`;
    }

    // è®¾ç½®æ–°è¿æ¥
    function setupConnection(conn, peerId) {
        if (connections.some(c => c.peerId === peerId)) return;
        
        const memberName = `æˆå‘˜${connections.length + 1}`;
        connections.push({ conn, peerId, memberName });

        conn.on('data', (data) => handleIncomingData(data, conn));
        
        conn.on('open', () => {
            // å‘é€è‡ªå·±çš„æ˜µç§°
            conn.send(encrypt('NICKNAME:' + myName));
        });
        
        conn.on('close', () => {
            connections = connections.filter(c => c.conn !== conn);
            updateMembersList();
            addMessageToUI('ğŸ‘‹ ä¸€ä½æˆå‘˜ç¦»å¼€äº†', 'ç³»ç»Ÿ');
        });

        updateMembersList();
        addMessageToUI(`âœ¨ æ–°æˆå‘˜åŠ å…¥: ${memberName}`, 'ç³»ç»Ÿ');
    }

    // åˆå§‹åŒ–Peer
    function initPeer() {
        if (peer) peer.destroy();
        peer = new Peer();
        
        peer.on('open', (id) => {
            myPeerId = id;
            peerIdDisplay.innerHTML = `<i class="fas fa-id-card"></i> ID: ${id}`;
        });

        peer.on('connection', (incomingConn) => {
            setupConnection(incomingConn, incomingConn.peer);
        });

        peer.on('error', (err) => {
            console.error('Peeré”™è¯¯:', err);
            alert('è¿æ¥æœåŠ¡å™¨å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•');
        });
    }

    // å¯åŠ¨Peer
    initPeer();

    // å¤åˆ¶ID
    copyIdBtn.addEventListener('click', () => {
        if (myPeerId) {
            navigator.clipboard.writeText(myPeerId);
            alert('IDå·²å¤åˆ¶');
        }
    });

    // è¿æ¥å¯¹æ–¹
    connectBtn.addEventListener('click', () => {
        const remoteId = remoteIdInput.value.trim();
        if (!remoteId) {
            alert('è¯·è¾“å…¥å¯¹æ–¹ID');
            return;
        }
        if (remoteId === myPeerId) {
            alert('ä¸èƒ½è¿æ¥è‡ªå·±');
            return;
        }
        if (connections.some(c => c.peerId === remoteId)) {
            alert('å·²ç»è¿æ¥è¿‡äº†');
            return;
        }
        
        const newConn = peer.connect(remoteId);
        if (newConn) {
            newConn.on('open', () => {
                setupConnection(newConn, remoteId);
            });
            newConn.on('error', () => {
                alert('è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ID');
            });
        } else {
            alert('è¿æ¥å¤±è´¥');
        }
        remoteIdInput.value = '';
    });

    // æ–­å¼€æ‰€æœ‰è¿æ¥
    disconnectBtn.addEventListener('click', () => {
        connections.forEach(c => c.conn.close());
        connections = [];
        updateMembersList();
        addMessageToUI('ğŸ“´ å·²æ–­å¼€æ‰€æœ‰è¿æ¥', 'ç³»ç»Ÿ');
    });

    // å‘é€æ–‡å­—æ¶ˆæ¯
    sendBtn.addEventListener('click', sendText);
    textInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendText();
        }
    });

    function sendText() {
        const raw = textInput.value.trim();
        if (!raw) return;
        
        if (connections.length > 0) {
            broadcastToAll(encrypt(raw));
        } else {
            addMessageToUI('âš ï¸ å½“å‰æ²¡æœ‰å…¶ä»–æˆå‘˜åœ¨çº¿', 'ç³»ç»Ÿ');
        }
        addMessageToUI(raw, myName);
        textInput.value = '';
        textInput.style.height = 'auto';
    }

    // è¡¨æƒ…æ’å…¥
    document.querySelectorAll('.emoji').forEach(el => {
        el.addEventListener('click', () => {
            textInput.value += el.getAttribute('data-emoji');
            textInput.focus();
        });
    });

    // æ–‡ä»¶ä¸Šä¼ 
    attachBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        const isImage = file.type.startsWith('image/');
        const isVideo = file.type.startsWith('video/');
        if (!isImage && !isVideo) {
            alert('åªæ”¯æŒå›¾ç‰‡æˆ–è§†é¢‘');
            return;
        }

        fileToBase64(file, (base64) => {
            const prefix = isImage ? 'IMAGE_BASE64:' : 'VIDEO_BASE64:';
            const data = prefix + base64;
            
            if (connections.length > 0) {
                broadcastToAll(encrypt(data));
            }
            displayMedia(base64, isImage ? 'image' : 'video', myName);
        });
        fileInput.value = '';
    });

    // æ¸…ç©ºèŠå¤©è®°å½•
    clearHistoryBtn.addEventListener('click', () => {
        messageArea.innerHTML = '';
        addMessageToUI('ğŸ’« å¯¹è¯å·²æ¸…ç©º', 'ç³»ç»Ÿ');
    });

    // è¾“å…¥æ¡†è‡ªé€‚åº”
    textInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = this.scrollHeight + 'px';
    });

    // åˆå§‹æ¶ˆæ¯
    addMessageToUI('ğŸ” 50ä½å›ºå®šå¯†ç åŠ å¯†å·²å¯ç”¨', 'ç³»ç»Ÿ');
    addMessageToUI('ğŸ“Œ å¤åˆ¶è‡ªå·±çš„IDå‘ç»™å¯¹æ–¹ï¼Œç„¶åç²˜è´´å¯¹æ–¹IDç‚¹å‡»"è¿æ¥"', 'ç³»ç»Ÿ');
})();
</script>
</body>
</html>